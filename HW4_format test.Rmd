---
title: "Part D. Models : Random Search with GBM Algorithm"
author: "Yuan Yi Chen (Eve)"
date: "2017年6月6日"
output: html_document
---

```{r, include = F}
setwd("C:/Users/Eve/Dropbox/UCLA Files/Courses/418 Tools of Data Science/STATS 418 - HW4")
```

```{r, include = F}
#Remove Objects
rm(list=ls())

#Clear Memory
gc(reset=TRUE)

#diR
setwd("C:/Users/Eve/Dropbox/UCLA Files/Courses/418 Tools of Data Science/STATS 418 - HW4")

#Packages
library(readr)   #Use to read data
library(glmnet)  #Use to apply logistic regression
library(ROCR)    #Use to calcuate AUC
library(h2o)     #Use to run logistic regression and random forest 
library(xgboost) #Use to run random forest model
library(randomForest)
```

```{r, include = F}
library(h2o)
```
```{r, include = F}
h2o.no_progress()
```

```{r, include = F}
h2o.init(nthreads=-1)
```

```{r, include=F}
#Data sets with validation
dx <- h2o.importFile("test.csv")
dx_split <- h2o.splitFrame(dx, ratios = c(0.6,0.2), seed = 123)
dx_train <- dx_split[[1]]
dx_valid <- dx_split[[2]]
dx_test <- dx_split[[3]]
Xnames <- setdiff(names(dx_train),"y")
```


###**D. Models**

```{r, include = F}
library(h2o)
```
```{r, include = F}
h2o.no_progress()
```

```{r, include = F}
h2o.init(nthreads=-1)
```

```{r, include=F}
#Data sets with validation
dx <- h2o.importFile("test.csv")
dx_split <- h2o.splitFrame(dx, ratios = c(0.6,0.2), seed = 123)
dx_train <- dx_split[[1]]
dx_valid <- dx_split[[2]]
dx_test <- dx_split[[3]]
Xnames <- setdiff(names(dx_train),"y")
```


####**6. Random Search (GBM)**

Step1: Change Xnames to Xnames_rs because random search uses different function instead of "setdiff"
*Notes: Originally, Xnames is 
Xnames <- setdiff(names(dx_train),"y")*
```{r, message = F}
Xnames_rs <- names(dx_train)[which(names(dx_train)!="y")]
```

Step2: Create list of hyperparameters

```{r}
hyper_params <- list( ntrees = 10000,  ## early stopping
                      max_depth = 5:15, 
                      min_rows = c(1,3,10,30,100),
                      learn_rate = c(0.01,0.03,0.1),  
                      learn_rate_annealing = c(0.99,0.995,1,1),
                      sample_rate = c(0.4,0.7,1,1),
                      col_sample_rate = c(0.7,1,1),
                      nbins = c(30,100,300),
                      nbins_cats = c(64,256,1024)
)
```

Step3: Create list of search criteria

```{r}
search_criteria <- list( strategy = "RandomDiscrete",
                         max_runtime_secs = 10*3600,
                         max_models = 20
)
```

Step4: Apply random search with GBM model 
```{r}
system.time({
  md_rs <- h2o.grid(algorithm = "gbm", grid_id = "grd",
                  x = Xnames_rs, y = "y", training_frame = dx_train,
                  validation_frame = dx_valid,
                  hyper_params = hyper_params,
                  search_criteria = search_criteria,
                  stopping_metric = "AUC", stopping_tolerance = 1e-3, stopping_rounds = 2,
                  seed = 123)
})
```


Step5: Make prediction and calculate AUC
```{r}
#To sort
md_rs <- h2o.getGrid(grid_id = "grd", sort_by = "auc", decreasing = TRUE)
md_rs
```

```{r}
#To see the best
md_rs_best <- h2o.getModel(md_rs@model_ids[[1]])
summary(md_rs_best)
```

```{r}
#AUC 
auc_rs <- h2o.auc(h2o.performance(md_rs_best, dx_test))
auc_rs
```


####**6. Random Search (GBM)**

